{% extends "base.html" %}

{% block title %}Уведомления{% endblock %}

{% block content %}
<div class="notifications-container">
    <h2>Мои уведомления</h2>
    
    <div id="notifications-list" class="notifications-list">
        <div class="loading">Загрузка уведомлений...</div>
    </div>
</div>

<style>
.notifications-container {
    max-width: 800px;
    margin: 40px auto;
    padding: 20px;
}

.notifications-container h2 {
    color: #1565C0;
    margin-bottom: 30px;
}

.notifications-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.notification-item {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: all 0.3s ease;
}

.notification-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.notification-item.unread {
    background: #E3F2FD;
    border-left: 4px solid #1565C0;
}

.notification-item.read {
    background: #f5f5f5;
    opacity: 0.8;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.notification-title {
    font-size: 18px;
    font-weight: bold;
    color: #333;
}

.notification-type {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
    text-transform: uppercase;
}

.notification-type.reminder {
    background: #4CAF50;
    color: white;
}

.notification-type.cancellation {
    background: #f44336;
    color: white;
}

.notification-message {
    color: #666;
    line-height: 1.6;
    margin-bottom: 10px;
}

.notification-time {
    font-size: 12px;
    color: #999;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #999;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #999;
}

.empty-state svg {
    width: 80px;
    height: 80px;
    margin-bottom: 20px;
    opacity: 0.3;
}

@media (max-width: 768px) {
    .notifications-container {
        margin: 20px;
        padding: 10px;
    }
    
    .notification-item {
        padding: 15px;
    }
    
    .notification-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    const phone = '{{ phone }}';
    const notificationsList = document.getElementById('notifications-list');
    
    // Function to update badge count
    async function updateBadgeCount() {
        try {
            const response = await fetch(`/api/notifications/${phone}/unread-count`);
            const data = await response.json();
            
            if (data.success) {
                const count = data.count || 0;
                
                // Try to find badge in parent/opener window
                let badge = document.getElementById('notificationBadge');
                
                // If badge exists in current page
                if (badge) {
                    if (count > 0) {
                        badge.textContent = count > 9 ? '9+' : count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
                
                // Also update via localStorage to trigger update in other tabs
                localStorage.setItem('notificationBadgeUpdate', Date.now().toString());
            }
        } catch (error) {
            console.error('Error updating badge count:', error);
        }
    }
    
    try {
        // Fetch notifications
        const response = await fetch(`/api/notifications/${phone}`);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || 'Failed to load notifications');
        }
        
        const notifications = data.notifications;
        
        if (notifications.length === 0) {
            notificationsList.innerHTML = `
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                    </svg>
                    <p>У вас пока нет уведомлений</p>
                </div>
            `;
            return;
        }
        
        // Render notifications
        notificationsList.innerHTML = notifications.map(notification => {
            const date = new Date(notification.created_at);
            const formattedDate = date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const typeLabel = notification.notification_type === 'reminder' ? 'Напоминание' : 'Отмена';
            const readClass = notification.is_read ? 'read' : 'unread';
            
            return `
                <div class="notification-item ${readClass}" data-id="${notification.id}" data-read="${notification.is_read}">
                    <div class="notification-header">
                        <div class="notification-title">${notification.title}</div>
                        <div class="notification-type ${notification.notification_type}">${typeLabel}</div>
                    </div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${formattedDate}</div>
                </div>
            `;
        }).join('');
        
        // Add click handlers to mark as read
        document.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', function() {
                const isRead = this.dataset.read === 'true';
                
                if (!isRead) {
                    // Change visual style immediately
                    this.classList.remove('unread');
                    this.classList.add('read');
                    this.dataset.read = 'true';
                    
                    // Update badge in current page if exists
                    const badge = document.getElementById('notificationBadge');
                    if (badge && badge.style.display !== 'none') {
                        let currentCount = parseInt(badge.textContent) || 0;
                        currentCount = Math.max(0, currentCount - 1);
                        
                        if (currentCount > 0) {
                            badge.textContent = currentCount > 9 ? '9+' : currentCount;
                            badge.style.display = 'flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                    
                    // Trigger update in other tabs/windows via localStorage
                    localStorage.setItem('notificationRead', Date.now().toString());
                    
                    // Send request to server in background
                    const notificationId = this.dataset.id;
                    fetch(`/api/notifications/${notificationId}/read`, {
                        method: 'POST'
                    }).catch(error => {
                        console.error('Failed to mark notification as read:', error);
                    });
                }
            });
        });
        
    } catch (error) {
        console.error('Error loading notifications:', error);
        notificationsList.innerHTML = `
            <div class="empty-state">
                <p>Ошибка загрузки уведомлений</p>
            </div>
        `;
    }
});
</script>
{% endblock %}
