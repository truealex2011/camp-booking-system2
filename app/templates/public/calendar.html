{% extends "base.html" %}

{% block title %}Выбор даты и времени - {{ service.name }}{% endblock %}

{% block extra_css %}
<style>
.calendar-container { margin: 20px 0; }
.calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; flex-wrap: wrap; }
.calendar-header h3 { flex: 1; text-align: center; min-width: 150px; margin: 0; }
.calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
.calendar-day { padding: 12px 8px; text-align: center; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.3s; font-size: 14px; }
.calendar-day:hover:not(.disabled) { background: #f0f0f0; transform: translateY(-2px); }
.calendar-day.disabled { opacity: 0.5; cursor: not-allowed; background: #f5f5f5; }
.calendar-day.selected { background: #1565C0; color: white; }

/* Hierarchical time slots - horizontal layout */
.time-slots { margin: 20px 0; }

/* Horizontal container for hourly slots */
.hourly-slots-horizontal {
    display: flex;
    flex-wrap: wrap; /* Allow wrapping if needed */
    gap: 8px; /* Smaller gap */
    justify-content: center; /* Center the hourly buttons */
    max-width: 100%; /* Use full width */
    padding-bottom: 10px; /* Space for scrollbar */
}

.hourly-slot-container {
    flex: 0 0 auto; /* Don't grow, fixed size */
    min-width: 90px; /* Smaller minimum width */
    position: static; /* Changed from relative to static */
}

.hourly-slot-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 15px;
    background: #FB8C00; /* Orange color */
    color: white;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    font-weight: 600;
    font-size: 15px;
    user-select: none;
    white-space: nowrap;
}

.hourly-slot-header:hover {
    background: #F57C00; /* Darker orange on hover */
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(251, 140, 0, 0.3);
}

.hourly-slot-header.disabled {
    background: #e0e0e0; /* Gray for disabled */
    color: #999;
    cursor: not-allowed;
    opacity: 0.6;
}

.hourly-slot-header.disabled:hover {
    transform: none;
    box-shadow: none;
}

.hourly-slot-container.expanded .hourly-slot-header {
    background: #F57C00; /* Darker orange when expanded */
    border-radius: 8px 8px 0 0;
}

.hourly-slot-container.expanded .hourly-slot-header.disabled {
    background: #e0e0e0; /* Keep gray when disabled */
}

.arrow-icon {
    font-size: 12px;
    transition: transform 0.3s;
}

.minute-slots-container {
    position: relative; /* Changed from absolute to relative */
    top: auto;
    left: auto;
    transform: none;
    min-width: 100%; /* Full width of parent */
    background: white;
    border: 2px solid #FB8C00; /* Orange border */
    border-top: none;
    border-radius: 0 0 8px 8px;
    padding: 10px;
    display: grid; /* Changed to grid for 2x2 layout */
    grid-template-columns: repeat(2, 1fr); /* 2 columns */
    gap: 8px;
    margin-top: -2px;
    z-index: 100; /* Ensure it appears above other elements */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.minute-slots-container.hidden {
    display: none !important; /* Force hide when hidden class is present */
}

.minute-slot {
    padding: 10px 15px;
    background: #f5f5f5;
    border: 2px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
    font-weight: 500;
}

.minute-slot:hover:not(.unavailable) {
    background: #E3F2FD;
    border-color: #1565C0;
    transform: translateX(5px);
}

.minute-slot.selected {
    background: #FB8C00;
    color: white;
    border-color: #F57C00;
}

.minute-slot.unavailable {
    background: #e0e0e0;
    color: #999;
    cursor: not-allowed;
    opacity: 0.6;
}

.minute-slot.unavailable:hover {
    transform: none;
    border-color: #ddd;
}

.booking-form { max-width: 600px; margin: 30px auto; padding: 30px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.form-group { margin-bottom: 20px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
.form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
.form-group input:focus, .form-group select:focus { outline: none; border-color: #FB8C00; }
.form-group .error { color: #d32f2f; font-size: 14px; margin-top: 5px; }
.hidden { display: none; }

@media (max-width: 768px) {
    .calendar-header { flex-direction: column; }
    .calendar-header button { width: 100%; }
    .calendar-grid { gap: 5px; }
    .calendar-day { padding: 10px 5px; font-size: 13px; }
    
    .hourly-slots-horizontal {
        gap: 10px;
    }
    
    .hourly-slot-container {
        min-width: 100px;
    }
    
    .hourly-slot-header {
        padding: 10px 15px;
        font-size: 14px;
    }
    
    .minute-slot {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    .booking-form { padding: 20px; margin: 20px 0; }
}

@media (max-width: 480px) {
    .calendar-grid { gap: 4px; }
    .calendar-day { padding: 8px 4px; font-size: 12px; border-radius: 6px; }
    
    .hourly-slots-horizontal {
        flex-direction: column;
    }
    
    .hourly-slot-container {
        width: 100%;
    }
    
    .hourly-slot-header {
        padding: 10px 12px;
        font-size: 14px;
        gap: 8px;
    }
    
    .minute-slot {
        padding: 8px;
        font-size: 13px;
    }
    
    .booking-form { padding: 15px; }
    .form-group input, .form-group select { font-size: 16px; padding: 10px; }
}
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>{{ service.name }}</h2>
    <p>Выберите удобные дату и время</p>
</div>

<div class="calendar-container">
    <div class="calendar-header">
        <button class="btn btn-secondary" id="prevMonth">&larr; Предыдущий</button>
        <h3 id="currentMonth"></h3>
        <button class="btn btn-secondary" id="nextMonth">Следующий &rarr;</button>
    </div>
    <div class="calendar-grid" id="calendarGrid"></div>
</div>

<div id="timeSlotsContainer" class="hidden">
    <h3>Доступное время на <span id="selectedDateDisplay"></span></h3>
    <div class="time-slots" id="timeSlots"></div>
</div>

<div id="bookingFormContainer" class="hidden">
    <form class="booking-form" id="bookingForm">
        <h3>Контактная информация</h3>
        
        <div class="form-group">
            <label for="lastName">Фамилия *</label>
            <input type="text" id="lastName" name="last_name" required>
            <div class="error" id="lastNameError"></div>
        </div>
        
        <div class="form-group">
            <label for="firstName">Имя *</label>
            <input type="text" id="firstName" name="first_name" required>
            <div class="error" id="firstNameError"></div>
        </div>
        
        <div class="form-group">
            <label for="phone">Телефон *</label>
            <input type="tel" id="phone" name="phone" placeholder="+7 (___) ___-__-__" required>
            <div class="error" id="phoneError"></div>
        </div>
        
        <div class="form-group">
            <label for="camp">Лагерь *</label>
            <select id="camp" name="camp" required>
                <option value="">Выберите лагерь</option>
                {% for camp in camps %}
                <option value="{{ camp }}">{{ camp }}</option>
                {% endfor %}
            </select>
            <div class="error" id="campError"></div>
        </div>
        
        <input type="hidden" id="selectedDate" name="date">
        <input type="hidden" id="selectedTimeSlot" name="time_slot">
        
        <button type="submit" class="btn btn-primary btn-large">Записаться</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/calendar.js') }}"></script>
<script src="{{ url_for('static', filename='js/phone_mask.js') }}"></script>
<script>
const calendar = new Calendar('calendarGrid', {{ service.id }});
const phoneMask = new PhoneMask(document.getElementById('phone'));

document.getElementById('bookingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const phone = formData.get('phone');
    
    try {
        const response = await fetch('{{ url_for("public.create_booking") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Save phone number to localStorage for notifications link
            if (phone) {
                // Get existing phones array or create new one
                let phones = JSON.parse(localStorage.getItem('userPhones') || '[]');
                
                // Add new phone if not already in list
                if (!phones.includes(phone)) {
                    phones.push(phone);
                    localStorage.setItem('userPhones', JSON.stringify(phones));
                }
                
                // Set current phone as last used
                localStorage.setItem('userPhone', phone);
            }
            window.location.href = data.redirect_url;
        } else {
            // Display errors
            if (data.field_errors) {
                for (const [field, error] of Object.entries(data.field_errors)) {
                    const errorEl = document.getElementById(field + 'Error');
                    if (errorEl) errorEl.textContent = error;
                }
            }
            alert(data.message || 'Произошла ошибка при создании бронирования');
        }
    } catch (error) {
        alert('Произошла ошибка. Пожалуйста, попробуйте позже.');
    }
});
</script>
{% endblock %}
